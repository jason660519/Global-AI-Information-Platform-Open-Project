name: GitHub Crawler Automation

on:
  schedule:
    # æ¯å¤©UTCæ™‚é–“6é»åŸ·è¡Œï¼ˆå°ç£æ™‚é–“ä¸‹åˆ2é»ï¼‰
    - cron: '0 6 * * *'
  workflow_dispatch:
    # å…è¨±æ‰‹å‹•è§¸ç™¼
    inputs:
      max_requests:
        description: 'æœ€å¤§è«‹æ±‚æ¬¡æ•¸'
        required: false
        default: '4500'
        type: string

# è¨­ç½®å·¥ä½œæµç¨‹æ¬Šé™
permissions:
  contents: write
  actions: read

jobs:
  crawl:
    runs-on: ubuntu-latest
    timeout-minutes: 30  # è¨­ç½®è¶…æ™‚æ™‚é–“
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Create logs directory
        run: mkdir -p logs
      
      - name: Run GitHub crawler
        run: node src/index.js
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_KEY: ${{ secrets.SUPABASE_KEY }}
          GITHUB_TOKEN: ${{ secrets.AI_INFORMATION_PLATFORMAPI_TOKEN }}
          MAX_REQUESTS: ${{ github.event.inputs.max_requests || '4500' }}
          NODE_ENV: production
      
      - name: Upload CSV exports as backup
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: github-trending-data-backup-${{ github.run_number }}
          path: exports/*.csv
          retention-days: 7
      
      - name: Upload logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: crawler-logs-${{ github.run_number }}
          path: logs/
          retention-days: 7
      
      - name: Commit and push CSV files
        if: success()
        run: |
          # é…ç½®Gitç”¨æˆ¶ä¿¡æ¯
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          
          # æª¢æŸ¥æ˜¯å¦æœ‰æ–°çš„CSVæ–‡ä»¶
          if [ -n "$(git status --porcelain exports/)" ]; then
            # æ·»åŠ æ‰€æœ‰exportsç›®éŒ„ä¸‹çš„æ–‡ä»¶
            git add exports/
            
            # æäº¤è®Šæ›´
            git commit -m "ğŸ¤– è‡ªå‹•æ›´æ–°GitHubè¶¨å‹¢æ•¸æ“š $(date +'%Y-%m-%d %H:%M:%S')"
            
            # æ¨é€åˆ°å€‰åº«
            git push
            
            echo "âœ… CSVæ–‡ä»¶å·²æˆåŠŸæäº¤åˆ°å€‰åº«"
          else
            echo "â„¹ï¸ æ²’æœ‰æ–°çš„CSVæ–‡ä»¶éœ€è¦æäº¤"
          fi